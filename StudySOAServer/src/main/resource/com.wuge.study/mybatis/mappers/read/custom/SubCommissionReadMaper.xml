<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.manyi.iw.contract.soa.server.mybatis.dao.read.custom.SubCommissionReadDao">

    <select id="selectReceipts"
            lang="velocity"
            parameterType="com.manyi.iw.contract.soa.api.model.vo.sale.subcommission.RRequestParam"
            resultType="com.manyi.iw.contract.soa.api.model.vo.sale.subcommission.SubCommissionResponseResult$SubCommissionReceiptVo">
        SELECT
        <include refid="tradeColumnList" />
        <include refid="tradeJoinSql" />
        where
        1=1
        #{if}($_parameter.receiptStates and ${_parameter.receiptStates.size()} != 0)
            and
            #{in}(${_parameter.receiptStates} $receiptState "r.state")
              @{receiptState}
            #{end}
        #{end}
        #{if}($_parameter.subCommissionType)
            #{if}($_parameter.subCommissionType == 1)
                and o.orderDataState=2
                and
                ((o.orderDataStateUpdateTime <![CDATA[>=]]> @{_parameter.startDate} and o.orderDataStateUpdateTime <![CDATA[<=]]> @{_parameter.endDate})
                or
                (t.tradeCompleteTime <![CDATA[>=]]> @{_parameter.startDate} and t.tradeCompleteTime <![CDATA[<=]]> @{_parameter.endDate}))
                and o.orderDataStateUpdateTime <![CDATA[<=]]> @{_parameter.endDate}
                and t.tradeCompleteTime <![CDATA[<=]]> @{_parameter.endDate}
            #{elseif}($_parameter.subCommissionType == 2)
                and o.markSpecialTime <![CDATA[>=]]> @{_parameter.startDate}
                and o.markSpecialTime <![CDATA[<=]]> @{_parameter.endDate}
            #{elseif}($_parameter.subCommissionType == 3)
                and o.state=60
                and o.orderCompleteTime <![CDATA[>=]]> @{_parameter.startDate}
                and o.orderCompleteTime <![CDATA[<=]]> @{_parameter.endDate}
            #{elseif}($_parameter.subCommissionType == 4)
                and o.state = 60 and o.orderStateExtra=2
                and
                ((o.timeLegalComplete <![CDATA[>=]]> @{_parameter.startDate} and o.timeLegalComplete <![CDATA[<=]]> @{_parameter.endDate})
                or
                (t.tradeCompleteTime <![CDATA[>=]]> @{_parameter.startDate} and t.tradeCompleteTime <![CDATA[<=]]> @{_parameter.endDate}))
                and o.timeLegalComplete <![CDATA[<=]]> @{_parameter.endDate}
                and t.tradeCompleteTime <![CDATA[<=]]> @{_parameter.endDate}
            #{elseif}($_parameter.subCommissionType == 5)
                and o.state = 90 and o.orderStateExtra=1
                and
                ((o.timeCancel <![CDATA[>=]]> @{_parameter.startDate} and o.timeCancel <![CDATA[<=]]> @{_parameter.endDate})
                or
                (t.tradeCompleteTime <![CDATA[>=]]> @{_parameter.startDate} and t.tradeCompleteTime <![CDATA[<=]]> @{_parameter.endDate}))
                and o.timeCancel <![CDATA[<=]]> @{_parameter.endDate}
                and t.tradeCompleteTime <![CDATA[<=]]> @{_parameter.endDate}
            #{end}
        #{end}
        #{if}($_parameter.specialStates and ${_parameter.specialStates.size()} != 0)
        and
        #{in}(${_parameter.specialStates} $specialState "o.specialState")
        @{specialState}
        #{end}
        #{end}
        #{if}($_parameter.receiptTypes and ${_parameter.receiptTypes.size()} != 0)
        and
        #{in}(${_parameter.receiptTypes} $receiptType "r.type")
        @{receiptType}
        #{end}
        #{end}
        #{if}($_parameter.orderCode)
        and o.code = @{_parameter.orderCode}
        #{end}
        #{if}($_parameter.receiptId)
        and r.id = @{_parameter.receiptId}
        #{end}
        <include refid="commonSQL" />
    </select>

    <sql id="tradeColumnList">
        #{prefix}("
        <include refid='com.manyi.iw.contract.soa.server.mybatis.dao.read.mbg.MBGSaleContractOrderReadDao.Base_Column_List'/>
        " "," "o." "")
        ,
        r.id as relationShipId,
        r.money as payamount,
        r.serialCode as serialCode,
        r.type as `type`,
        t.tradeCreateTime,
        t.tradeCompleteTime,
        t.tradeReceiveSystemMoneyTime,
        t.tradeReceiveMoneyTime,
        t.id as tradeSerialNumber
    </sql>
    <sql id="tradeJoinSql">
        from iw_sale_contract_order_receipt r
        left join iw_sale_contract_order o on r.orderId = o.id
        left join iw_sale_contract_trade_transaction t on r.tradeId=t.id
    </sql>

    <sql id="outAccountColumnList">
        #{prefix}("
        <include refid='com.manyi.iw.contract.soa.server.mybatis.dao.read.mbg.MBGSaleContractOrderReadDao.Base_Column_List'/>
        " "," "o." "")
        ,
        a.id as relationShipId,
        0 - a.money as payamount,
        a.serialCode as serialCode,
        a.outAccountType as `type`,
        a.createtime as tradeCreateTime,
        a.timeFinanceOutAccount as tradeCompleteTime,
        a.timeFinanceOutAccount as tradeReceiveSystemMoneyTime,
        a.timeFinanceOutAccount as tradeReceiveMoneyTime,
        a.id as tradeSerialNumber
    </sql>

    <sql id="outAccountJoin">
        from iw_sale_contract_order_out_account a
        LEFT JOIN iw_sale_contract_order_out_account_item i on a.id = i.outAccountId
        LEFT JOIN iw_sale_contract_order o ON a.orderId = o.id
        left join iw_sale_contract_order_receipt  r on  a.id = r.tradeId
    </sql>
    
    <select id="backCommission"
            lang="velocity"
            parameterType="com.manyi.iw.contract.soa.api.model.vo.sale.subcommission.ORequestParam"
            resultType="com.manyi.iw.contract.soa.api.model.vo.sale.subcommission.SubCommissionResponseResult$SubCommissionReceiptVo">
        select
        <include refid="outAccountColumnList" />
        <include refid="outAccountJoin"/>
        where
        #{in}(${_parameter.outAccountTypes} $outAccountType "a.outAccountType")
        @{outAccountType}
        #{end}
        AND
        (a.outAccountWay = 1 OR a.outAccountWay = 2
        AND
        #{in}(${_parameter.outAccountItemTypes} $outAccountItemType "i.outAccountItemType not ")
        @{outAccountItemType}
        #{end}
        )
        AND a.state=40
        #{if}($_parameter.subCommissionType)
            #{if}($_parameter.subCommissionType == 1)
                <!--正常单流水数据 居间证件齐全 时间在昨天的数据-->
                AND o.orderDataState=2
                AND (a.timeFinanceOutAccount <![CDATA[>=]]>@{_parameter.startDate}
                AND a.timeFinanceOutAccount <![CDATA[<=]]>@{_parameter.endDate} OR o.orderDataStateUpdateTime <![CDATA[>=]]>@{_parameter.startDate} AND o.orderDataStateUpdateTime <![CDATA[<=]]>@{_parameter.endDate})
                AND a.timeFinanceOutAccount <![CDATA[<=]]>@{_parameter.endDate}
                AND o.orderDataStateUpdateTime <![CDATA[<=]]>@{_parameter.endDate}
            #{elseif}($_parameter.subCommissionType == 2)
                <!--特殊流水数据-->
                AND o.markSpecialTime <![CDATA[<=]]>@{_parameter.endDate}
                AND o.markSpecialTime <![CDATA[>=]]> @{_parameter.startDate}
            #{elseif}($_parameter.subCommissionType == 3)
                <!--已经结单流水数据-->
                AND o.orderCompleteTime <![CDATA[>]]> @{_parameter.startDate}
                AND o.orderCompleteTime <![CDATA[<=]]> @{_parameter.endDate}
                AND o.state=60
            #{elseif}($_parameter.subCommissionType == 4)
                and o.state = 60 and o.orderStateExtra=2
                and
                ((o.timeLegalComplete <![CDATA[>=]]> @{_parameter.startDate} and o.timeLegalComplete <![CDATA[<=]]> @{_parameter.endDate})
                or
                (a.timeFinanceOutAccount <![CDATA[>=]]> @{_parameter.startDate} and a.timeFinanceOutAccount <![CDATA[<=]]> @{_parameter.endDate}))
                and o.timeLegalComplete <![CDATA[<=]]> @{_parameter.endDate}
                and a.timeFinanceOutAccount <![CDATA[<=]]> @{_parameter.endDate}
            #{elseif}($_parameter.subCommissionType == 5)
                and o.state = 90 and o.orderStateExtra=1
                and
                ((o.timeCancel <![CDATA[>=]]> @{_parameter.startDate} and o.timeCancel <![CDATA[<=]]> @{_parameter.endDate})
                or
                (a.timeFinanceOutAccount <![CDATA[>=]]> @{_parameter.startDate} and a.timeFinanceOutAccount <![CDATA[<=]]> @{_parameter.endDate}))
                and o.timeCancel <![CDATA[<=]]> @{_parameter.endDate}
                and a.timeFinanceOutAccount <![CDATA[<=]]> @{_parameter.endDate}
            #{end}
        #{end}
        #{if}($_parameter.specialStates and ${_parameter.specialStates.size()} != 0)
            and
            #{in}(${_parameter.specialStates} $specialState "o.specialState")
              @{specialState}
            #{end}
        #{end}
        #{if}($_parameter.orderCode)
          and o.code = @{_parameter.orderCode}
        #{end}
        #{if}($_parameter.receiptId)
          and r.id = @{_parameter.receiptId}
        #{end}
        <include refid="commonSQL" />
    </select>

    <select id="transferCommission"
            lang="velocity"
            parameterType="com.manyi.iw.contract.soa.api.model.vo.sale.subcommission.IRequestParam"
            resultType="com.manyi.iw.contract.soa.api.model.vo.sale.subcommission.SubCommissionResponseResult$SubCommissionReceiptVo">
        select
        <include refid="outAccountItemColumnList" />
        <include refid="outAccountItemJoin"/>
        where
        a.outAccountWay = 2
        and
        #{in}(${_parameter.outAccountTypes} $outAccountType "a.outAccountType not ")
          @{outAccountType}
        #{end}
        AND
        #{in}(${_parameter.outAccountItemTypes} $outAccountItemType "i.outAccountItemType")
          @{outAccountItemType}
        #{end}
        AND a.state = 40
        #{if}($_parameter.subCommissionType)
            #{if}($_parameter.subCommissionType == 1)
                <!--正常单流水数据 居间证件齐全 时间在昨天的数据-->
                AND o.orderDataState=2
                AND (a.timeFinanceOutAccount <![CDATA[>=]]>@{_parameter.startDate} AND a.timeFinanceOutAccount <![CDATA[<=]]>@{_parameter.endDate} OR o.orderDataStateUpdateTime <![CDATA[>=]]>@{_parameter.startDate} AND o.orderDataStateUpdateTime <![CDATA[<=]]>@{_parameter.endDate})
                AND a.timeFinanceOutAccount <![CDATA[<=]]>@{_parameter.endDate}
                AND o.orderDataStateUpdateTime <![CDATA[<=]]>@{_parameter.endDate}
            #{elseif}($_parameter.subCommissionType == 2)
                <!--特殊流水数据-->
                AND o.markSpecialTime <![CDATA[<=]]>@{_parameter.endDate}
                AND o.markSpecialTime <![CDATA[>=]]> @{_parameter.startDate}
            #{elseif}($_parameter.subCommissionType == 3)
                <!--已经结单流水数据-->
                AND o.orderCompleteTime <![CDATA[>=]]>@{_parameter.startDate}
                AND o.orderCompleteTime <![CDATA[<=]]>@{_parameter.endDate}
                AND o.state=60
            #{elseif}($_parameter.subCommissionType == 4)
                and o.state = 60 and o.orderStateExtra=2
                and
                ((o.timeLegalComplete <![CDATA[>=]]> @{_parameter.startDate} and o.timeLegalComplete <![CDATA[<=]]> @{_parameter.endDate})
                or
                (a.timeFinanceOutAccount <![CDATA[>=]]> @{_parameter.startDate} and a.timeFinanceOutAccount <![CDATA[<=]]> @{_parameter.endDate}))
                and o.timeLegalComplete <![CDATA[<=]]> @{_parameter.endDate}
                and a.timeFinanceOutAccount <![CDATA[<=]]> @{_parameter.endDate}
            #{elseif}($_parameter.subCommissionType == 5)
                and o.state = 90 and o.orderStateExtra=1
                and
                ((o.timeCancel <![CDATA[>=]]> @{_parameter.startDate} and o.timeCancel <![CDATA[<=]]> @{_parameter.endDate})
                or
                (a.timeFinanceOutAccount <![CDATA[>=]]> @{_parameter.startDate} and a.timeFinanceOutAccount <![CDATA[<=]]> @{_parameter.endDate}))
                and o.timeCancel <![CDATA[<=]]> @{_parameter.endDate}
                and a.timeFinanceOutAccount <![CDATA[<=]]> @{_parameter.endDate}
            #{end}
        #{end}
        #{if}($_parameter.specialStates and ${_parameter.specialStates.size()} != 0)
            and
            #{in}(${_parameter.specialStates} $specialState "o.specialState")
              @{specialState}
            #{end}
        #{end}
        #{if}($_parameter.orderCode)
          and o.code = @{_parameter.orderCode}
        #{end}
        <include refid="commonSQL" />
    </select>

    <sql id="outAccountItemColumnList">
        #{prefix}("
        <include refid='com.manyi.iw.contract.soa.server.mybatis.dao.read.mbg.MBGSaleContractOrderReadDao.Base_Column_List'/>
        " "," "o." "")
        ,
        i.outAccountId as relationShipId,
        i.serialCode as serialCode,
        i.outAccountItemType as `type`,
        i.outAccountItemMoney as payamount,
        a.createtime as tradeCreateTime,
        a.timeFinanceOutAccount as tradeCompleteTime,
        a.timeFinanceOutAccount as tradeReceiveSystemMoneyTime,
        a.timeFinanceOutAccount as tradeReceiveMoneyTime,
        a.id as tradeSerialNumber
    </sql>

    <sql id="outAccountItemJoin">
        from iw_sale_contract_order_out_account a
        LEFT JOIN iw_sale_contract_order_out_account_item i on a.id = i.outAccountId
        LEFT JOIN iw_sale_contract_order o ON a.orderId = o.id
        left join iw_sale_contract_order_receipt  r on  a.id = r.tradeId
    </sql>

    <sql id="commonSQL">
       #{if}(${_parameter.orderByField} and ${_parameter.orderByField} != "")
          order by ${_parameter.orderByField} ${_parameter.orderBy}
        #{end}
    </sql>
</mapper>
