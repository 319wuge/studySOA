<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.manyi.iw.contract.soa.server.mybatis.dao.contract.read.custom.AgentContractBillReadDao">
    <select id="getAgentContractBillListByContractId"
            resultMap="com.manyi.iw.contract.soa.server.mybatis.dao.contract.read.mbg.MBGAgentContractBillReadDao.BaseResultMap"
            resultType="com.manyi.iw.contract.soa.api.model.po.mbg.AgentContractBill">
        select *
        FROM
        iw_agent_contract_bill
        WHERE
        contractId=#{contractId}
    </select>
    <select id="queryUncompletedBillsCountByUserId" resultType="java.lang.Integer">
        select count(b.id) from iw_agent_contract_bill b
        INNER JOIN
        iw_agent_contract t
        on b.contractId=t.id
        WHERE b.userId=#{userId}
        and b.state='1'
        <![CDATA[
            and t.state<>'90'

        ]]>
    </select>

    <select id="queryUncompletedBillsCountByUserIdAndContractId"
            resultMap="com.manyi.iw.contract.soa.server.mybatis.dao.contract.read.mbg.MBGAgentContractBillReadDao.BaseResultMap"
            resultType="com.manyi.iw.contract.soa.api.model.po.mbg.AgentContractBill">
        select *
        FROM
        iw_agent_contract_bill
        WHERE
        userId=#{userId}
        and contractId=#{contractId}
        and type='2'
        and state='1'
    </select>

    <select id="selectContractBillResponse" parameterType="java.util.List"
            resultType="com.manyi.iw.contract.soa.api.model.vo.rent.AgentContractBillResponse">
        SELECT
        b.id,
        b.createTime,
        b.billCode,
        b.money,
        b.type,
        b.state,
        c.houseId
        FROM
        iw_agent_contract_bill b
        JOIN iw_agent_contract c ON b.contractId = c.id
        <![CDATA[
            AND b.type <> 9
        ]]>
        WHERE
        (
        b.state = 1
        OR (
        b.state = 2 <![CDATA[AND b.successTime >= date_sub(NOW(), INTERVAL 2 DAY)]]>
        )
        )
        AND b.createAgentId IN
        <foreach collection="agentIds" item="agentId" separator="," open="(" close=")">
            #{agentId}
        </foreach>
        ORDER BY
        createTime DESC
    </select>

    <select id="selectSuccessBill" parameterType="java.util.List"
            resultType="com.manyi.iw.contract.soa.api.model.vo.rent.AgentContractBillResponseExt">
        SELECT
        b.id,
        r.transferId,
        t.money,
        t.tradeNo,
        t.state,
        t.`status`
        FROM
        iw_agent_contract_bill b
        LEFT JOIN iw_agent_contract_transfer_ref r ON b.id = r.billId
        LEFT JOIN iw_agent_contract_transfer t ON r.transferId = t.id
        where b.id in
        <foreach collection="billIds" item="billId" separator="," open="(" close=")">
            #{billId}
        </foreach>
        and t.state=2 and t.`status`=1 and t.tradeNo is not NULL;
    </select>
</mapper>